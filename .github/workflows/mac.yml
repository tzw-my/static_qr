name: build socat windows
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: install
        run: |
          choco install cygwin
          choco install wget
          choco uninstall mingw
          choco install strawberryperl
      # - name: install perl
      #   shell: powershell
      #   run: |
      #     cpan
      #     cpan App::cpanminus
      #     cpanm Locale::Maketext::Simple
      # - name: build openssl
      #   shell: bash
      #   run: |
      #     curl -LO https://github.com/openssl/openssl/releases/download/openssl-3.1.1/openssl-3.1.1.tar.gz
      #     tar zxvf openssl-3.1.1.tar.gz
      #     (
      #         cd openssl-3.1.1 && {
      #             ./config
      #             sudo make
      #             sudo make install
      #         }
      #     )
      
      # - name: install apt-cyg
      #   shell: bash
      #   run: | 
      #     command -v cygwin
      #     bin_dir="$(command -v cygwin)"
      #     curl -LO https://github.com/transcode-open/apt-cyg/archive/refs/heads/master.zip
      #     unzip master.zip
      #     mv apt-cyg-master/apt-cyg "${bin_dir%/*}"
      #     apt-cyg install gcc-core gcc-fortran gcc-g++ gcc-objc gcc-objc++ libkrb5-devel libkrb5_3 libreadline-devel libssl-devel libwrap-devel make tcp_wrappers
      - name: build socat
        shell: bash
        run: |
          cygwin
          gcc -v
          curl -LO http://www.dest-unreach.org/socat/download/socat-1.7.4.4.tar.gz
          tar xvf socat-1.7.4.4.tar.gz
          dir="$(pwd)"
          (
              cd socat-1.7.4.4 && {
                  ./configure --enable-fips --enable-openssl-method --prefix="$dir"/socat_win_x64
                  make
                  make install
              }
            strip "$dir"/socat_win_x64/bin/socat
            ldd  "$dir"/socat_win_x64/bin/socat || echo "------"
          )
          tar cJvf socat_win_x64.tar.xz socat_win_x64
      - uses: actions/upload-artifact@v3
        with:
          path: socat_win_x64.tar.xz
          name: socat_win_x64
      
