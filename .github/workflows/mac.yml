name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    container: ubuntu:latest
    steps:
      - uses: actions/checkout@v2
      - name: install
        run: |
          apt-get update
          apt-get install -y gcc g++ make autoconf automake libtool pkg-config wget p7zip-full
          apt remove -y openssl libssl-dev
      - name: build libressl
        run: |
          wget https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-3.5.2.tar.gz
          tar zxvf libressl-3.5.2.tar.gz
          cd libressl-3.5.2 && {
            ./config no-shared LDFLAGS="-static"
            make
            make install
            cd ..
          }
      - name: build zlib
        run: |
          wget -O zlib-1.2.12.tar.gz https://github.com/madler/zlib/archive/refs/tags/v1.2.12.tar.gz
          tar zxvf zlib-1.2.12.tar.gz
          cd zlib-1.2.12 && {
            ./configure --static
            make
            make install
          }
      - name: build ssh2
        run: |
          wget https://github.com/libssh2/libssh2/archive/refs/tags/libssh2-1.10.0.tar.gz
          tar zxvf libssh2-1.10.0.tar.gz
          cd libssh2-libssh2-1.10.0 && {
            autoreconf -fi
            LDFLAGS="-static" CFLAGS="-DHAVE_OPAQUE_STRUCTS=1 "   ./configure
            make
            make install
          }
      - name: build curl
        run: |
          wget https://curl.se/download/curl-7.86.0.tar.gz
          tar zxvf curl-7.86.0.tar.gz
          cd curl-7.86.0 && {
            autoreconf -fi
            LDFLAGS="-static" PKG_CONFIG="pkg-config --static" ./configure --with-libssh2 --with-zlib --with-openssl --prefix=/home/build/curl
            make -j4 LDFLAGS="-static -all-static"
            make install
          }
      - name: strip
        run: |
          pwd
          strip /home/build/curl/bin/curl
          mv /home/build/curl/bin/curl /home/build/curl/bin/curl.linux.x64
      - name: compression
        run: |
          7z a curl.linux.x64.7z /home/build/curl/bin/curl.linux.x64
      - uses: actions/upload-artifact@v3
        with:
          path: curl.linux.x64.7z
          name: curl
