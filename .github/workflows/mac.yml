# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: install
        run: |
          sudo apt-get update
          sudo apt install -y gcc g++ make automake autoconf pkg-config m4 curl libtool autotools-dev unzip zlib1g-dev
      - name: static build
        run: |
          dir="$(pwd)"
          (
            curl -L https://sourceforge.net/projects/libpng/files/libpng16/1.6.39/libpng-1.6.39.tar.xz/download -o libpng-1.6.39.tar.xz
            tar xvf libpng-1.6.39.tar.xz
            cd libpng-1.6.39 && {
                LDFLAGS="-static" ./configure 
                make
                sudo make install 
            }
          )
          (
            curl -LO https://github.com/fukuchi/libqrencode/archive/refs/tags/v4.1.1.zip
            unzip v4.1.1.zip 
            cd libqrencode-4.1.1/ && {
                . ./autogen.sh
                LDFLAGS="-static" ./configure  --prefix="${dir}/qrencode_linux_x64"
                make -j4 LDFLAGS="-static -all-static"
                make install
                strip "${dir}/bin/qrencode"
                ldd "${dir}/bin/qrencode" || echo "------"
                ls -lh "${dir}/bin/"
            }
          )
          (
            cd "${dir}" && {
              tar cJvf qrencode_linux_x64.tar.xz qrencode_linux_x64
            }
          )
      - uses: actions/upload-artifact@v3
        with:
          path: "qrencode_linux_x64.tar.xz"
          name: "qrencode_linux_x64"