name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: install
        run: |
          sudo apt-get install libbrotli-dev
      - name: build libressl
        run: |
          wget https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-3.5.2.tar.gz
          tar zxvf libressl-3.5.2.tar.gz
          cd libressl-3.5.2 && {
            ./config no-shared LDFLAGS="-static"
            sudo make
            sudo make install
            cd ..
          }
      - name: build zlib
        run: |
          wget -O zlib-1.2.12.tar.gz https://github.com/madler/zlib/archive/refs/tags/v1.2.12.tar.gz
          tar zxvf zlib-1.2.12.tar.gz
          cd zlib-1.2.12 && {
            ./configure --static
            sudo make
            sudo make install
          }
      - name: build ssh2
        run: |
          wget https://github.com/libssh2/libssh2/archive/refs/tags/libssh2-1.10.0.tar.gz
          tar zxvf libssh2-1.10.0.tar.gz
          cd libssh2-libssh2-1.10.0 && {
            autoreconf -fi
            LDFLAGS="-static" CFLAGS="-DHAVE_OPAQUE_STRUCTS=1 "   ./configure
            sudo make
            sudo make install
          }
      - name: build curl
        run: |
          wget https://curl.se/download/curl-7.86.0.tar.gz
          tar zxvf curl-7.86.0.tar.gz
          cd curl-7.86.0 && {
            autoreconf -fi
            LDFLAGS="-static" ./configure --with-zlib --with-openssl --prefix=/home/runner/work/static_qr/static_qr/curl
            sudo make 
            sudo make install
          }
      - name: strip
        run: |
          strip /home/runner/work/static_qr/static_qr/curl/bin/curl
          mv /home/runner/work/static_qr/static_qr/curl/bin/curl /home/runner/work/static_qr/static_qr/curl/bin/curl.linux.x64
          ldd /home/runner/work/static_qr/static_qr/curl/bin/curl.linux.x64
      - name: compression
        run: |
          7z a curl.linux.x64.7z /home/runner/work/static_qr/static_qr/curl/bin/curl.linux.x64
      - uses: actions/upload-artifact@v3
        with:
          path: curl.linux.x64.7z
          name: curl
