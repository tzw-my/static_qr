name: build socat windows
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: install
        run: |
          choco install mingw
      - name: build openssl
        shell: bash
        run: |
          curl -LO https://github.com/openssl/openssl/releases/download/openssl-3.1.1/openssl-3.1.1.tar.gz
          tar zxvf openssl-3.1.1.tar.gz
          (
              cd openssl-3.1.1 && {
                  ./config
                  sudo make
                  sudo make install
              }
          )
      - name: build socat
        shell: bash
        run: |
          curl -LO http://www.dest-unreach.org/socat/download/socat-1.7.4.4.tar.gz
          tar xvf socat-1.7.4.4.tar.gz
          dir="$(pwd)"
          (
              cd socat-1.7.4.4 && {
                  ./configure --enable-fips --enable-openssl-method --prefix="$dir"/socat_darwin_x64
                  make
                  make install
              }
            strip "$dir"/socat_darwin_x64/bin/socat
            ldd  "$dir"/socat_darwin_x64/bin/socat || echo "------"
          )
          tar cJvf socat_darwin_x64.tar.xz socat_darwin_x64
      - uses: actions/upload-artifact@v3
        with:
          path: socat_darwin_x64.tar.xz
          name: socat_darwin_x64
      
